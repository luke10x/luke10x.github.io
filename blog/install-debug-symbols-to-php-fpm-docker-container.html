<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="shortcut icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns=&#x27;http://www.w3.org/2000/svg&#x27; 
          viewBox=&#x27;0 0 100 100&#x27;
          %3E%3Ccircle 
          cx=&#x27;50&#x27; cy=&#x27;50&#x27; r=&#x27;50&#x27; fill=&#x27;%23ff33ff&#x27; /%3E%3C/svg%3E"/><link rel="preload" href="/_next/static/css/f74e7403dfc41554.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f74e7403dfc41554.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-cda2f1305c3d9424.js" defer=""></script><script src="/_next/static/chunks/main-83cebdb887f48834.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6257153885dc7086.js" defer=""></script><script src="/_next/static/chunks/980-500204586efa6805.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-16f621665fa931ac.js" defer=""></script><script src="/_next/static/jxg3s3yU4HdFy4I86wlDI/_buildManifest.js" defer=""></script><script src="/_next/static/jxg3s3yU4HdFy4I86wlDI/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="flex flex-col min-h-screen"><header class="bg-slate-200 mb-8 py-4"><div class="container mx-auto flex justify-center"><div><a href="/"><h1 class="text-black font-roboto text-5xl mb-2">LUKE 10X</h1><span class="block text-center text-gray-500 text-xxs block">FULLSTACK DEVELOPER &amp; CODE INSTRUCTOR</span></a></div><span class="mx-auto"></span> </div></header><main class="container mx-auto flex-1"><div class="prose mx-auto"><h1>Install debug symbols to fpm Docker container</h1><div class="flex flex-wrap gap-2">2018-06-18T23:24:52+00:00</div><div><p>Container images don't include debug symbols,
perhaps it is more important to reduce size of the images.</p>
<p>Unlike Debian that has all the <package>-dbg' packages
(alternatively, it is possible to get <package>-dbgsym),
Docker image vendors virtually never provide separate versions
with debug symbols enabled. Wordpress official images are
not exceptions.</p>
<p>I can think of the following reasons why the vendors
of the Docker container images don't consider
interactive debugging as a must-have feature anymore:</p>
<ul>
<li>Debug symbols increase the image size;</li>
<li>The code runs in the cloud, that means does not matter where it
is actually running, so it is not clear how we can attach the
debugger;</li>
<li>Advanced paradigms, like async and coroutines make imperative
stepping through instructions a technique that gives good
insight of the runtime state.</li>
<li>Similarly, the machine code may be optimized in a sophisticated
way, so that throttling it to human speed would make it impossible
to reproduce bugs anyway.</li>
</ul>
<p>However PHP is quite old and primitive, therefore it can still
be the best to debug it with the good old GDB.</p>
<p>Here, I will try to log, step-by-step what was required to do,
in order to rebuild the image to include the debugging symbols at
the same time reusing as much as possible from the original image,
and not rebuilding everything from scratch.</p>
<h2>Assess the situation</h2>
<p>First we will double check that the debug symbols are not there originally:</p>
<pre><code>root@63a355210d9b:/src# file /usr/local/sbin/php-fpm
/usr/local/sbin/php-fpm: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=3a1b578d90a949925775c0827920ff4205ee16e3, stripped
</code></pre>
<p>That &quot;stripped&quot; means that the binary does not include the debugging data.
(also this can be checked using the 'objdump --syms')</p>
<p>So debug symbols are not installed!</p>
<p>As the image is Debian based, we can check if the php is installed as a package,
as that would allow us just to install additional php-fpm-dbg package:</p>
<pre><code>root@63a355210d9b:/src# dpkg -S $(which php-fpm) 
dpkg-query: no path found matching pattern /usr/local/sbin/php-fpm
</code></pre>
<p>looks like no, also:</p>
<pre><code>apt-file find $(which php-fpm)
</code></pre>
<p>does not print anything.</p>
<p>So it is clear that PHP is not installed from the APT package.</p>
<p>Nevertheless, checking the history, shows that indeed the message includes
PHP compiled from sources:</p>
<pre><code>docker history --no-trunc --format '{{.CreatedBy }}' wordpress:fpm
...
    /bin/sh -c set -xe  &amp;&amp; buildDeps=&quot;   $PHP_EXTRA_BUILD_DEPS   libargon2-0-dev   libcurl4-openssl-dev   libedit-dev   libsqlite3-dev   libssl-dev   libxml2-dev   zlib1g-dev  &quot;  &amp;&amp; apt-get update &amp;&amp; apt-get install -y $buildDeps --no-install-recommends &amp;&amp; rm -rf /var/lib/apt/lists/*   &amp;&amp; export CFLAGS=&quot;$PHP_CFLAGS&quot;   CPPFLAGS=&quot;$PHP_CPPFLAGS&quot;   LDFLAGS=&quot;$PHP_LDFLAGS&quot;  &amp;&amp; docker-php-source extract  &amp;&amp; cd /usr/src/php  &amp;&amp; gnuArch=&quot;$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)&quot;  &amp;&amp; debMultiarch=&quot;$(dpkg-architecture --query DEB_BUILD_MULTIARCH)&quot;  &amp;&amp; if [ ! -d /usr/include/curl ]; then   ln -sT &quot;/usr/include/$debMultiarch/curl&quot; /usr/local/include/curl;  fi  &amp;&amp; ./configure   --build=&quot;$gnuArch&quot;   --with-config-file-path=&quot;$PHP_INI_DIR&quot;   --with-config-file-scan-dir=&quot;$PHP_INI_DIR/conf.d&quot;     --disable-cgi     --enable-ftp   --enable-mbstring   --enable-mysqlnd   --with-password-argon2     --with-curl   --with-libedit   --with-openssl   --with-zlib     $(test &quot;$gnuArch&quot; = 's390x-linux-gnu' &amp;&amp; echo '--without-pcre-jit')   --with-libdir=&quot;lib/$debMultiarch&quot;     $PHP_EXTRA_CONFIGURE_ARGS  &amp;&amp; make -j &quot;$(nproc)&quot;  &amp;&amp; make install  &amp;&amp; { find /usr/local/bin /usr/local/sbin -type f -executable -exec strip --strip-all '{}' + || true; }  &amp;&amp; make clean  &amp;&amp; cd /  &amp;&amp; docker-php-source delete   &amp;&amp; apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false $buildDeps   &amp;&amp; pecl update-channels  &amp;&amp; rm -rf /tmp/pear ~/.pearrc
...
</code></pre>
<p>So we will need to find the <a href="https://github.com/docker-library/php/blob/6677546d599d3980781b520f84d03ecaad291dd1/7.2/stretch/fpm/Dockerfile#L104-L166">original Dockerfile</a>,
to see what command needs to be re-run for our custom image to include the symbols.</p>
<p>We will have to put <a href="https://github.com/normantas/enchanted-lamp/blob/master/docker/wordpress/Dockerfile#L45-L46">our Dockerfile</a>,
that recompiles the PHP with <code>--enable-debug</code> flag set.</p>
<p>After the installation we need to rebuild plugins required for the Wordpress with <a href="https://github.com/normantas/enchanted-lamp/blob/master/docker/wordpress/Dockerfile#L61-L69">docker-php-ext-install</a>.</p>
<p>And that is it! After rebuilding this image one should see:</p>
<pre><code>file /usr/local/sbin/php-fpm
/usr/local/sbin/php-fpm: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=4f0f0802b93f011a3d1faa92be7e2c0d8646f78a, not stripped
</code></pre>
<p>Meaning that our image now can be debugged with GDB!</p>
</div><div class="flex space-x-4"><a class="before:absolute before:-left-2" href="/">⬅ back</a></div></div></main><footer class="bg-slate-200 mt-8 py-4"><div class="container mx-auto flex justify-center">© 2023 Luke 10X</div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"slug":"/blog/install-debug-symbols-to-php-fpm-docker-container","date":"2018-06-18T23:24:52+00:00","draft":false,"title":"Install debug symbols to fpm Docker container","socialImage":"social-img/debug-symbols.png"},"content":"\nContainer images don't include debug symbols,\nperhaps it is more important to reduce size of the images.\n\nUnlike Debian that has all the \u003cpackage\u003e-dbg' packages\n(alternatively, it is possible to get \u003cpackage\u003e-dbgsym),\nDocker image vendors virtually never provide separate versions\nwith debug symbols enabled. Wordpress official images are\nnot exceptions.\n\nI can think of the following reasons why the vendors\nof the Docker container images don't consider\ninteractive debugging as a must-have feature anymore:\n\n- Debug symbols increase the image size;\n- The code runs in the cloud, that means does not matter where it\n  is actually running, so it is not clear how we can attach the \n  debugger;\n- Advanced paradigms, like async and coroutines make imperative\n  stepping through instructions a technique that gives good\n  insight of the runtime state.\n- Similarly, the machine code may be optimized in a sophisticated \n  way, so that throttling it to human speed would make it impossible\n  to reproduce bugs anyway.\n\nHowever PHP is quite old and primitive, therefore it can still\nbe the best to debug it with the good old GDB.\n\nHere, I will try to log, step-by-step what was required to do,\nin order to rebuild the image to include the debugging symbols at\nthe same time reusing as much as possible from the original image,\nand not rebuilding everything from scratch.\n\n## Assess the situation\n\nFirst we will double check that the debug symbols are not there originally:\n\n    root@63a355210d9b:/src# file /usr/local/sbin/php-fpm\n    /usr/local/sbin/php-fpm: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=3a1b578d90a949925775c0827920ff4205ee16e3, stripped\n\nThat \"stripped\" means that the binary does not include the debugging data.\n(also this can be checked using the 'objdump --syms')\n\nSo debug symbols are not installed!\n\nAs the image is Debian based, we can check if the php is installed as a package,\nas that would allow us just to install additional php-fpm-dbg package:\n\n    root@63a355210d9b:/src# dpkg -S $(which php-fpm) \n    dpkg-query: no path found matching pattern /usr/local/sbin/php-fpm\n\nlooks like no, also:\n\n    apt-file find $(which php-fpm)\n\ndoes not print anything.\n\nSo it is clear that PHP is not installed from the APT package.\n\nNevertheless, checking the history, shows that indeed the message includes\nPHP compiled from sources:\n\n    docker history --no-trunc --format '{{.CreatedBy }}' wordpress:fpm\n    ...\n        /bin/sh -c set -xe  \u0026\u0026 buildDeps=\"   $PHP_EXTRA_BUILD_DEPS   libargon2-0-dev   libcurl4-openssl-dev   libedit-dev   libsqlite3-dev   libssl-dev   libxml2-dev   zlib1g-dev  \"  \u0026\u0026 apt-get update \u0026\u0026 apt-get install -y $buildDeps --no-install-recommends \u0026\u0026 rm -rf /var/lib/apt/lists/*   \u0026\u0026 export CFLAGS=\"$PHP_CFLAGS\"   CPPFLAGS=\"$PHP_CPPFLAGS\"   LDFLAGS=\"$PHP_LDFLAGS\"  \u0026\u0026 docker-php-source extract  \u0026\u0026 cd /usr/src/php  \u0026\u0026 gnuArch=\"$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)\"  \u0026\u0026 debMultiarch=\"$(dpkg-architecture --query DEB_BUILD_MULTIARCH)\"  \u0026\u0026 if [ ! -d /usr/include/curl ]; then   ln -sT \"/usr/include/$debMultiarch/curl\" /usr/local/include/curl;  fi  \u0026\u0026 ./configure   --build=\"$gnuArch\"   --with-config-file-path=\"$PHP_INI_DIR\"   --with-config-file-scan-dir=\"$PHP_INI_DIR/conf.d\"     --disable-cgi     --enable-ftp   --enable-mbstring   --enable-mysqlnd   --with-password-argon2     --with-curl   --with-libedit   --with-openssl   --with-zlib     $(test \"$gnuArch\" = 's390x-linux-gnu' \u0026\u0026 echo '--without-pcre-jit')   --with-libdir=\"lib/$debMultiarch\"     $PHP_EXTRA_CONFIGURE_ARGS  \u0026\u0026 make -j \"$(nproc)\"  \u0026\u0026 make install  \u0026\u0026 { find /usr/local/bin /usr/local/sbin -type f -executable -exec strip --strip-all '{}' + || true; }  \u0026\u0026 make clean  \u0026\u0026 cd /  \u0026\u0026 docker-php-source delete   \u0026\u0026 apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false $buildDeps   \u0026\u0026 pecl update-channels  \u0026\u0026 rm -rf /tmp/pear ~/.pearrc\n    ...\n\nSo we will need to find the [original Dockerfile](https://github.com/docker-library/php/blob/6677546d599d3980781b520f84d03ecaad291dd1/7.2/stretch/fpm/Dockerfile#L104-L166),\nto see what command needs to be re-run for our custom image to include the symbols.\n\nWe will have to put [our Dockerfile](https://github.com/normantas/enchanted-lamp/blob/master/docker/wordpress/Dockerfile#L45-L46),\nthat recompiles the PHP with `--enable-debug` flag set.\n\nAfter the installation we need to rebuild plugins required for the Wordpress with [docker-php-ext-install](https://github.com/normantas/enchanted-lamp/blob/master/docker/wordpress/Dockerfile#L61-L69).\n\nAnd that is it! After rebuilding this image one should see:\n\n    file /usr/local/sbin/php-fpm\n    /usr/local/sbin/php-fpm: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=4f0f0802b93f011a3d1faa92be7e2c0d8646f78a, not stripped\n\nMeaning that our image now can be debugged with GDB!\n\n\n\n\n\n\n\n\n\n\n\n\n"},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"install-debug-symbols-to-php-fpm-docker-container"},"buildId":"jxg3s3yU4HdFy4I86wlDI","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>